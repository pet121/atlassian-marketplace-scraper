# Руководство по управлению через веб-интерфейс

## Обзор

Веб-интерфейс теперь позволяет управлять всеми задачами скрапинга и настройками прямо из браузера, без необходимости использовать командную строку.

## Доступ к панели управления

1. Запустите веб-интерфейс:
   ```powershell
   python app.py
   ```

2. Откройте в браузере: **http://localhost:5000**

3. Перейдите в раздел **"Management"** в меню навигации или нажмите кнопку **"Management & Control"** на главной странице.

## Управление задачами

### 1. Сбор приложений (Scrape Apps)

**Назначение:** Сбор метаданных всех приложений из Atlassian Marketplace

**Кнопки:**
- **Start Fresh** — начать сбор с нуля
- **Resume** — продолжить с последнего чекпоинта

**Использование:**
1. Нажмите нужную кнопку
2. Задача запустится в фоновом режиме
3. Статус отобразится в разделе "Task Status"

### 2. Сбор версий (Scrape Versions)

**Назначение:** Сбор информации о версиях для всех приложений

**Использование:**
1. Нажмите кнопку **"Start"**
2. Задача запустится автоматически
3. Обрабатывает все приложения параллельно (10 воркеров по умолчанию)

**Примечание:** Требует, чтобы сначала был выполнен сбор приложений.

### 3. Загрузка бинарников (Download Binaries)

**Назначение:** Скачивание JAR/OBR файлов для всех версий

**Использование:**
1. (Опционально) Выберите продукт из выпадающего списка для загрузки только одного продукта
2. Нажмите кнопку **"Start Download"**
3. Загрузка выполняется параллельно (3 потока по умолчанию)

**Примечание:** Требует, чтобы сначала был выполнен сбор версий.

### 4. Загрузка описаний (Download Descriptions)

**Назначение:** Скачивание описаний плагинов с картинками и видео со страниц Atlassian Marketplace

**Использование:**
1. (Опционально) Введите addon_key для загрузки описания конкретного плагина
2. (Опционально) Снимите галочку "Download media files" если не нужно скачивать изображения и видео
3. Нажмите кнопку **"Start Description Download"**
4. Описания сохраняются в HTML и JSON форматах с медиа-файлами

**Примечание:** 
- Описания сохраняются в `I:\marketplace\metadata\descriptions\{addon_key}\`
- Каждое описание включает HTML-страницу, JSON-данные и медиа-файлы (если включено)
- Просмотр описаний доступен через раздел "Descriptions" в меню или на странице деталей приложения

## Управление настройками

### Просмотр текущих настроек

Текущие значения настроек отображаются в форме на странице управления. Значения берутся из файла `.env`.

### Изменение настроек

1. Измените нужные значения в форме
2. Нажмите кнопку **"Save Settings"**
3. Настройки будут сохранены в файл `.env`
4. **Важно:** Перезапустите Flask приложение для применения изменений

### Доступные настройки:

- **Scraper Batch Size** — количество приложений за один API запрос (1-100)
- **Request Delay** — задержка между запросами в секундах (0.1+)
- **Version Age Limit (days)** — фильтр по возрасту версий (0 = все версии)
- **Max Concurrent Downloads** — параллельные загрузки (1-10)
- **Version Scraper Workers** — воркеры для сбора версий (1-20)
- **Max Retry Attempts** — попытки повтора при ошибках (1-10)

## Мониторинг задач

### Статус задач

В разделе **"Task Status"** отображается:
- История последних 10 задач
- Статус каждой задачи (running, completed, failed)
- Время запуска
- Сообщения о прогрессе
- Последняя строка лога для каждой задачи
- Прогресс выполнения (если доступен)

### Управление задачами

- **Отмена задачи**: Нажмите кнопку "Cancel" рядом с задачей для её отмены
- **Очистка завершенных задач**: Нажмите кнопку "Clear Completed Tasks" для удаления завершенных задач из истории
- **Автообновление**: Статус задач обновляется автоматически каждые 10 секунд

### Управление задачами

- **Отмена задачи**: Нажмите кнопку "Cancel" рядом с задачей для её отмены
- **Очистка завершенных задач**: Нажмите кнопку "Clear Completed Tasks" для удаления завершенных задач из истории
- **Автообновление**: Статус задач обновляется автоматически каждые 10 секунд

### Ручное обновление

Нажмите кнопку **"Refresh"** для немедленного обновления статуса.

## Статусы задач

- **running** — задача выполняется
- **completed** — задача успешно завершена
- **failed** — задача завершилась с ошибкой

## Важные замечания

1. **Перезапуск приложения:** После изменения настроек необходимо перезапустить Flask приложение (`python app.py`)

2. **Одновременные задачи:** Не рекомендуется запускать несколько задач одного типа одновременно

3. **Последовательность:** Рекомендуется выполнять задачи в порядке:
   - Сбор приложений → Сбор версий → Загрузка бинарников

4. **Логи:** Детальные логи доступны в `I:\marketplace\logs\`

5. **Безопасность:** Изменение настроек через веб-интерфейс записывает их в `.env` файл. Убедитесь, что файл защищен от несанкционированного доступа.

## Решение проблем

### Задача не запускается

- Проверьте, что виртуальное окружение активировано
- Убедитесь, что скрипты существуют в корне проекта
- Проверьте логи в `I:\marketplace\logs\`

### Настройки не применяются

- Убедитесь, что вы перезапустили Flask приложение после сохранения
- Проверьте, что файл `.env` существует и доступен для записи
- Проверьте формат значений (числа должны быть без кавычек)

### Задача зависла

- Проверьте логи задачи
- Перезапустите Flask приложение
- Проверьте, что процесс не завершился с ошибкой

## Просмотр описаний

### Страница списка описаний

Перейдите в раздел **"Descriptions"** в меню навигации для просмотра всех приложений с загруженными описаниями.

### Просмотр описания приложения

1. Откройте страницу деталей приложения (`/apps/<addon_key>`)
2. Если для приложения загружены описания, они будут отображены в разделе "Downloaded Descriptions"
3. Нажмите на ссылку описания для просмотра в новой вкладке

### Структура сохраненных описаний

```
I:\marketplace\metadata\descriptions\
  └── {addon_key}/
      ├── {addon_key}_{version}.html    # HTML-страница описания
      ├── {addon_key}_{version}.json    # JSON-данные
      └── media/                         # Медиа-файлы (если включено)
          ├── image1.jpg
          ├── video1.mp4
          └── ...
```

## Построение поискового индекса

### Запуск индексации

1. В разделе **"Build Search Index"** нажмите кнопку **"Start Build Index"**
2. Задача запустится в фоновом режиме
3. Прогресс отображается в разделе "Task Status"
4. После завершения индекс будет доступен для поиска

### Когда нужно перестроить индекс

- После скачивания новых описаний плагинов
- После обновления release notes
- Если поиск не находит недавно добавленные данные

**Примечание:** Индекс автоматически перестраивается при первом использовании поиска, если он не существует.

## Работа с таблицами

### Сортировка таблиц

На страницах **Storage** и **Descriptions** можно сортировать данные по клику на заголовки колонок:
- Первый клик: сортировка по возрастанию (↑)
- Второй клик: сортировка по убыванию (↓)
- Индикатор направления сортировки отображается рядом с заголовком

### Фильтрация таблиц

- **Страница Storage**: Используйте поле "Filter by path or drive..." для поиска папок по пути или диску
- **Страница Descriptions**: Используйте поле "Filter by app name, addon key, or vendor..." для поиска приложений

**Примечание:** Пустые папки (0 MB, 0 files) автоматически скрыты на странице Storage.

## Тестирование системы

### Запуск smoke tests

Smoke tests проверяют, что основные функции системы работают корректно:

```bash
# Базовый запуск
python run_smoke_tests.py

# С подробным выводом
python run_smoke_tests.py --verbose

# Только быстрые тесты
python run_smoke_tests.py --quick
```

### Что проверяют smoke tests

- Инициализация компонентов (MetadataStore, DownloadManager)
- Базовые операции (получение данных, статистика)
- Поиск (Whoosh, Enhanced, Simple fallback)
- Файловая система (существование директорий)
- Настройки (загрузка и валидация)
- Структура данных (правильность форматов ответов)

**Подробнее:** См. `tests/README.md`

## API Endpoints

Для программного доступа доступны следующие API endpoints:

- `POST /api/tasks/start/scrape-apps` — запуск сбора приложений
- `POST /api/tasks/start/scrape-versions` — запуск сбора версий
- `POST /api/tasks/start/download` — запуск загрузки бинарников
- `POST /api/tasks/start/download-descriptions` — запуск загрузки описаний
- `POST /api/tasks/start/build-index` — запуск построения поискового индекса
- `GET /api/tasks` — получение всех задач
- `GET /api/tasks/<task_id>` — статус конкретной задачи
- `GET /api/settings` — получение настроек
- `POST /api/settings` — обновление настроек
- `GET /api/search?q=query` — полнотекстовый поиск
- `GET /descriptions` — список приложений с описаниями
- `GET /apps/<addon_key>/description/<filename>` — просмотр описания

