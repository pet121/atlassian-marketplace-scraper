# Архитектура проекта Atlassian Marketplace Scraper

## Обзор

Atlassian Marketplace Scraper — это Python-приложение для сбора данных о приложениях из Atlassian Marketplace, включая метаданные приложений, информацию о версиях и загрузку бинарных файлов (JAR/OBR). Проект состоит из трех основных компонентов: скраперы, менеджер загрузок и веб-интерфейс.

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                    Пользовательский слой                      │
├─────────────────────────────────────────────────────────────┤
│  CLI скрипты:                                                │
│  - run_scraper.py (сбор приложений)                          │
│  - run_version_scraper.py (сбор версий)                     │
│  - run_downloader.py (загрузка бинарников)                   │
│  - run_description_downloader.py (скачивание описаний)       │
│  - app.py (веб-интерфейс Flask)                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Бизнес-логика                              │
├─────────────────────────────────────────────────────────────┤
│  scraper/                                                     │
│  ├── AppScraper          → Сбор приложений                   │
│  ├── VersionScraper      → Сбор версий (параллельно)         │
│  ├── DownloadManager     → Загрузка бинарников (параллельно) │
│  ├── DescriptionDownloader → Скачивание описаний (Playwright) │
│  ├── MarketplaceAPI      → API клиент v2                     │
│  ├── MarketplaceAPIv3    → API клиент v3                     │
│  └── Filters             → Фильтрация по дате/хостингу       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Слой данных                                │
├─────────────────────────────────────────────────────────────┤
│  models/                                                     │
│  ├── App              → Модель приложения                     │
│  ├── Version          → Модель версии                        │
│  └── DownloadStatus   → Статус загрузки                      │
│                                                               │
│  scraper/metadata_store.py                                    │
│  ├── MetadataStoreJSON    → Хранение в JSON (по умолчанию)   │
│  └── MetadataStoreSQLite  → Хранение в SQLite (опционально)  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Утилиты                                    │
├─────────────────────────────────────────────────────────────┤
│  utils/                                                       │
│  ├── RateLimiter       → Ограничение частоты запросов        │
│  ├── Checkpoint        → Сохранение прогресса                │
│  └── Logger            → Логирование                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Внешние API                                │
├─────────────────────────────────────────────────────────────┤
│  Atlassian Marketplace API:                                   │
│  - REST API v2 (marketplace.atlassian.com/rest/2)            │
│  - REST API v3 (api.atlassian.com/marketplace/rest/3)        │
└─────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. Слой скрапинга (Scraper Layer)

#### 1.1. AppScraper (`scraper/app_scraper.py`)
**Назначение:** Сбор метаданных приложений из Marketplace

**Основные функции:**
- `scrape_all_products()` — сбор приложений для всех продуктов (Jira, Confluence, Bitbucket, Bamboo, Crowd)
- `scrape_product_apps()` — сбор приложений для конкретного продукта
- `scrape_single_app()` — сбор одного приложения по ключу

**Особенности:**
- Использует пагинацию API (batch_size = 50)
- Система чекпоинтов каждые 100 приложений
- Поддержка возобновления после прерывания
- Фильтрация только Server/Data Center приложений

**Зависимости:**
- `MarketplaceAPI` — для запросов к API
- `MetadataStore` — для сохранения данных
- `Checkpoint` — для сохранения прогресса

#### 1.2. VersionScraper (`scraper/version_scraper.py`)
**Назначение:** Сбор информации о версиях приложений

**Основные функции:**
- `scrape_all_app_versions()` — параллельный сбор версий для всех приложений
- `scrape_app_versions()` — сбор версий для конкретного приложения

**Особенности:**
- Параллельная обработка (ThreadPoolExecutor, по умолчанию 10 воркеров)
- Использует API v3 для получения appSoftwareIds
- Фильтрация по дате (последние 365 дней)
- Фильтрация по типу хостинга (только Server/Data Center)

**Зависимости:**
- `MarketplaceAPI` (v2) — для базовых запросов
- `MarketplaceAPIv3` — для получения версий
- `MetadataStore` — для сохранения
- `Filters` — для фильтрации данных

#### 1.3. DescriptionDownloader (`scraper/description_downloader.py`)
**Назначение:** Скачивание описаний плагинов со страниц Marketplace

**Основные функции:**
- `download_description()` — скачивание описания для одного приложения
- `download_all_descriptions()` — скачивание описаний для всех приложений
- `save_marketplace_page_with_playwright()` — сохранение страницы через Playwright (headless браузер)
- `save_marketplace_plugin_page()` — сохранение страницы с удалением скриптов (fallback)
- `save_marketplace_plugin_page_static()` — генерация статического HTML из API данных

**Особенности:**
- **Playwright метод (рекомендуется):** Использует headless Chromium для выполнения JavaScript и захвата полностью отрендеренной страницы
  - Формат MHTML: один файл со всеми ресурсами (CSS, изображения, шрифты)
  - Формат HTML: HTML + папка с ресурсами
  - Автоматическая авторизация через Basic Auth
  - Ожидание завершения загрузки JavaScript
- **Метод удаления скриптов (fallback):** Удаляет все `<script>` теги для предотвращения SPA роутинга
  - Скачивает CSS и изображения локально
  - Переписывает ссылки на локальные файлы
  - Работает оффлайн, но может не содержать контент, загружаемый через JavaScript
- **Статический API метод (fallback):** Генерирует HTML из данных REST API
  - Не требует JavaScript
  - Работает оффлайн
  - Может не содержать весь визуальный контент со страницы

**Зависимости:**
- `Playwright` — для headless браузера (опционально, но рекомендуется)
- `BeautifulSoup4` — для парсинга HTML
- `requests` — для HTTP запросов
- `MarketplaceAPI` — для получения данных через API

**Требования:**
- Playwright браузер: `playwright install chromium`
- Интернет-соединение для доступа к Marketplace

**Формат сохранения:**
- MHTML файлы: `{DESCRIPTIONS_DIR}/{addon_key}/full_page/index.mhtml`
- HTML файлы: `{DESCRIPTIONS_DIR}/{addon_key}/full_page/index.html`
- Медиа-файлы: `{DESCRIPTIONS_DIR}/{addon_key}/media/`

#### 1.4. DownloadManager (`scraper/download_manager.py`)
**Назначение:** Загрузка бинарных файлов (JAR/OBR)

**Основные функции:**
- `download_all_versions()` — загрузка всех версий
- `download_specific_version()` — загрузка конкретной версии
- `_download_single_version()` — внутренняя функция загрузки

**Особенности:**
- Параллельные загрузки (по умолчанию 3 потока)
- Автоматические повторы при ошибках (до 3 попыток)
- Проверка существующих файлов (пропуск уже загруженных)
- Проверка размера файла после загрузки
- Организация файлов: `data/binaries/{product}/{app_key}/{version_id}/`

**Зависимости:**
- `MarketplaceAPI` — для получения URL загрузки
- `MetadataStore` — для обновления статуса загрузки

### 2. API клиенты

#### 2.1. MarketplaceAPI (`scraper/marketplace_api.py`)
**Назначение:** Клиент для REST API v2

**Основные методы:**
- `search_apps()` — поиск приложений с фильтрами
- `get_app_details()` — детали приложения
- `get_app_versions()` — список версий (с пагинацией)
- `get_all_app_versions()` — все версии (автоматическая пагинация)
- `get_download_url()` — URL для загрузки
- `download_binary()` — загрузка файла

**Особенности:**
- Базовая HTTP-аутентификация (username + API token)
- Rate limiting с адаптивными задержками
- Автоматические повторы при ошибках (429, 5xx)
- Exponential backoff при повторах

#### 2.2. MarketplaceAPIv3 (`scraper/marketplace_api_v3.py`)
**Назначение:** Клиент для REST API v3 (используется для версий)

**Основные методы:**
- `get_app_software_ids()` — получение appSoftwareIds для приложения
- `get_all_app_versions_v3()` — получение всех версий через v3 API
- `format_compatibility_string()` — форматирование строки совместимости

**Особенности:**
- Используется для более детальной информации о версиях
- Поддержка разных типов хостинга (server, datacenter, cloud)

### 3. Слой данных

#### 3.1. Модели данных (`models/`)

**App (`models/app.py`):**
```python
@dataclass
class App:
    addon_key: str
    name: str
    vendor: str
    description: str
    products: List[str]
    hosting: List[str]
    categories: List[str]
    # ... другие поля
```

**Version (`models/version.py`):**
```python
@dataclass
class Version:
    addon_key: str
    version_id: str
    version_name: str
    release_date: str
    hosting_type: str
    download_url: Optional[str]
    downloaded: bool
    # ... другие поля
```

#### 3.2. Хранилище метаданных (`scraper/metadata_store.py`)

**MetadataStoreJSON:**
- Хранение приложений: `data/metadata/apps.json`
- Хранение версий: `data/metadata/versions/{app_key}_versions.json`
- Простая структура, легко читать/редактировать

**MetadataStoreSQLite:**
- Единая база данных: `data/metadata/marketplace.db`
- Более эффективные запросы
- Поддержка транзакций

**Выбор хранилища:** Контролируется через `USE_SQLITE` в настройках

**Основные методы:**
- `save_app()` / `save_apps_batch()` — сохранение приложений
- `get_all_apps()` — получение всех приложений (с фильтрами и пагинацией)
- `get_app_by_key()` — получение приложения по ключу
- `save_versions()` — сохранение версий
- `get_app_versions()` — получение версий приложения
- `update_version_download_status()` — обновление статуса загрузки

### 4. Веб-интерфейс (`web/`)

#### 4.1. Flask приложение (`app.py`)
**Назначение:** Веб-сервер для просмотра собранных данных

**Структура:**
- `web/routes.py` — маршруты Flask
- `web/templates/` — HTML шаблоны (Jinja2)
- `web/static/` — CSS и JavaScript
- `web/search_index_whoosh.py` — полнотекстовый поиск с Whoosh

**Маршруты:**
- `GET /` — главная страница (дашборд со статистикой)
- `GET /apps` — список приложений (с фильтрами и пагинацией)
- `GET /apps/<addon_key>` — детали приложения
- `GET /descriptions` — список скачанных описаний плагинов
- `GET /storage` — детальная статистика хранилища
- `GET /search` — страница поиска по описаниям и release notes
- `GET /download/<product>/<addon_key>/<version_id>` — загрузка бинарника
- `GET /api/apps` — JSON API для приложений
- `GET /api/apps/<addon_key>` — JSON API для деталей
- `GET /api/stats` — статистика
- `GET /api/storage-stats` — детальная статистика хранилища (JSON)
- `GET /api/products` — список продуктов
- `GET /api/credentials` — получение учетных записей (masked)
- `POST /api/credentials` — сохранение учетных записей
- `GET /api/search` — полнотекстовый поиск по описаниям и release notes
- `POST /api/tasks/start/build-index` — запуск задачи индексации (с отслеживанием прогресса)
- `POST /api/search/rebuild-index` — перестроение поискового индекса (синхронно, устаревший метод)

**Особенности:**
- **Ленивая загрузка** детальной статистики хранилища (AJAX)
- **Кэширование** статистики на стороне сервера
- **Управление несколькими учетными записями** через веб-интерфейс
- **Отображение ссылок на документацию вендора** для плагинов (на странице деталей и в списке описаний)
- **Полнотекстовый поиск** по описаниям плагинов и release notes с использованием Whoosh
- **Оптимизация производительности:**
  - Параллельная загрузка данных при открытии страниц
  - Легковесный API для задач (уменьшает размер ответа)
  - Оптимизированное чтение лог-файлов
  - Умное автообновление с увеличенными интервалами

#### 4.2. Система поиска

##### 4.2.1. Whoosh Search Index (`web/search_index_whoosh.py`)
**Назначение:** Полнотекстовый поиск по описаниям плагинов и release notes

**Технология:** Whoosh — чисто Python библиотека для полнотекстового поиска

**Основные функции:**
- `WhooshSearchIndex.build_index()` — построение поискового индекса с выводом прогресса
- `WhooshSearchIndex.search()` — выполнение поисковых запросов с улучшенной обработкой ошибок
- `WhooshSearchIndex.needs_rebuild()` — проверка необходимости перестроения индекса

**Особенности:**
- **Индексация всех источников:**
  - JSON описания (summary, overview, highlights, addon info)
  - Full page HTML файлы (текст извлекается без HTML тегов)
  - Release Notes из базы данных
- **Автоматическое удаление HTML тегов** перед индексацией
- **Поддержка сложных запросов:**
  - Простые слова: `table`
  - Фразы: `table grid`
  - Wildcards: `table*`
  - Boolean операторы: `table AND grid`, `table OR jira`
- **Ранжирование результатов** по релевантности
- **Подсветка совпадений** в результатах поиска
- **Автоматическое перестроение индекса** при первом использовании
- **Кэширование индекса** в `DESCRIPTIONS_DIR/.whoosh_index/`
- **Ручная индексация через задачу:** Запуск индексации как фоновой задачи с отслеживанием прогресса через веб-интерфейс
- **Улучшенная обработка ошибок:**
  - Проверка на пустой индекс перед поиском
  - Fallback на простой поиск по терминам при ошибках парсинга запроса
  - Улучшенное извлечение highlights с fallback на текстовые фрагменты

##### 4.2.2. Enhanced Search (`web/search_enhanced.py`)
**Назначение:** Комплексный поиск по всем локальным источникам данных

**Особенности:**
- **Многоуровневая система поиска:**
  1. Whoosh (если индекс существует) — быстрый полнотекстовый поиск
  2. Enhanced Search — поиск по всем локальным данным
  3. Simple Text Search — базовый поиск по именам/вендорам (fallback)
- **Поиск по всем источникам:**
  - Имена приложений, вендоры, ключи (addon_key)
  - Категории и продукты
  - JSON описания (summary, overview, highlights, addon info)
  - HTML описания (full page)
  - Release Notes из базы данных
- **Система релевантности:**
  - Взвешенные оценки для разных типов совпадений
  - Совпадение в имени приложения: +10 баллов
  - Совпадение в вендоре: +8 баллов
  - Совпадение в ключе: +6 баллов
  - Совпадение в описании: +7 баллов (точное) или +4 балла (по словам)
  - Совпадение в release notes: +6 баллов (точное) или +3 балла (по словам)
- **Извлечение контекста:** Показывает фрагмент текста вокруг совпадения
- **Автоматический fallback:** Если Whoosh недоступен или не находит результатов, автоматически используется Enhanced Search

**Скрипт индексации (`run_index_search.py`):**
- Запускается как отдельная задача через TaskManager
- Выводит прогресс индексации в реальном времени
- Показывает количество обработанных и проиндексированных плагинов
- Может быть запущен вручную через веб-интерфейс (Management → Build Search Index)

**Схема индекса:**
```python
Schema(
    addon_key=ID(stored=True, unique=True),
    app_name=TEXT(stored=True),
    vendor=TEXT(stored=True),
    products=KEYWORD(stored=True),
    json_text=TEXT,
    html_text=TEXT,
    release_notes_text=TEXT,
    all_text=TEXT  # Объединенное поле для общего поиска
)
```

### 5. Утилиты (`utils/`)

#### 5.1. RateLimiter (`utils/rate_limiter.py`)
**Назначение:** Контроль частоты запросов к API

**Механизм:**
- Базовая задержка между запросами (по умолчанию 0.5 сек)
- Адаптивные задержки на основе HTTP статусов:
  - 429 (Too Many Requests) → увеличение задержки
  - 5xx (Server Error) → увеличение задержки
  - 200 (OK) → нормальная задержка

#### 5.2. Checkpoint (`utils/checkpoint.py`)
**Назначение:** Сохранение прогресса для возобновления работы

**Механизм:**
- Сохранение состояния в pickle файл
- Периодическое сохранение (каждые 100 приложений)
- Восстановление состояния при запуске с `--resume`

**Структура состояния:**
```python
{
    'product_index': 0,
    'current_product': 'jira',
    'app_offset': 0,
    'apps_processed': 150,
    'apps_collected': [...]
}
```

#### 5.3. Logger (`utils/logger.py`)
**Назначение:** Централизованное логирование

**Особенности:**
- Разные логгеры для разных модулей (scraper, download, web)
- Запись в файлы: `logs/scraper.log`, `logs/download.log`
- Уровни логирования: DEBUG, INFO, WARNING, ERROR

### 6. Конфигурация (`config/`)

#### 6.1. Settings (`config/settings.py`)
**Назначение:** Централизованные настройки из переменных окружения

**Основные параметры:**
- `MARKETPLACE_USERNAME` — имя пользователя для API
- `MARKETPLACE_API_TOKEN` — токен API
- `SCRAPER_BATCH_SIZE` — размер батча для запросов (50)
- `SCRAPER_REQUEST_DELAY` — задержка между запросами (0.5 сек)
- `VERSION_AGE_LIMIT_DAYS` — фильтр по возрасту версий (365 дней)
- `MAX_CONCURRENT_DOWNLOADS` — параллельные загрузки (3)
- `MAX_VERSION_SCRAPER_WORKERS` — воркеры для версий (10)
- `USE_SQLITE` — использовать SQLite вместо JSON

#### 6.2. Products (`config/products.py`)
**Назначение:** Определение продуктов Atlassian

**Продукты:**
- jira
- confluence
- bitbucket
- bamboo
- crowd

## Потоки данных

### Поток 1: Сбор приложений
```
run_scraper.py
    ↓
AppScraper.scrape_all_products()
    ↓
MarketplaceAPI.search_apps() [для каждого продукта]
    ↓
App.from_api_response() [преобразование данных]
    ↓
MetadataStore.save_apps_batch() [сохранение]
    ↓
Checkpoint.save_checkpoint() [периодически]
```

### Поток 2: Сбор версий
```
run_version_scraper.py
    ↓
VersionScraper.scrape_all_app_versions()
    ↓
[ThreadPoolExecutor: параллельная обработка]
    ↓
VersionScraper.scrape_app_versions()
    ├─→ MarketplaceAPIv3.get_app_software_ids()
    ├─→ MarketplaceAPIv3.get_all_app_versions_v3()
    ├─→ Filters.filter_by_date()
    └─→ Filters.filter_by_hosting()
    ↓
Version.from_v3_api_response()
    ↓
MetadataStore.save_versions()
```

### Поток 3: Загрузка бинарников
```
run_downloader.py
    ↓
DownloadManager.download_all_versions()
    ↓
[ThreadPoolExecutor: параллельные загрузки]
    ↓
DownloadManager._download_single_version()
    ├─→ MarketplaceAPI.get_download_url()
    ├─→ requests.get() [загрузка файла]
    └─→ MetadataStore.update_version_download_status()
```

### Поток 4: Веб-интерфейс
```
app.py (Flask)
    ↓
web/routes.py [обработка HTTP запросов]
    ↓
MetadataStore.get_all_apps() / get_app_versions()
    ↓
render_template() [отображение HTML]
```

## Обработка ошибок

### Стратегии обработки ошибок:

1. **API запросы:**
   - Автоматические повторы при 429, 5xx ошибках
   - Exponential backoff
   - Логирование ошибок

2. **Загрузка файлов:**
   - До 3 попыток загрузки
   - Удаление частично загруженных файлов при ошибке
   - Проверка размера файла после загрузки

3. **Прерывание работы:**
   - Checkpoint система для возобновления
   - Обработка KeyboardInterrupt
   - Сохранение прогресса

4. **Веб-интерфейс:**
   - Обработка 404, 500 ошибок
   - Отображение понятных сообщений об ошибках

## Производительность

### Оптимизации:

1. **Параллелизм:**
   - VersionScraper: 10 параллельных воркеров
   - DownloadManager: 3 параллельные загрузки
   - ThreadPoolExecutor для эффективного использования ресурсов
   - **Ротация учетных записей** для параллельных запросов к API

2. **Rate Limiting:**
   - Адаптивные задержки
   - Предотвращение блокировок API
   - **Автоматическая ротация учетных записей** при ошибке 429

3. **Хранение данных:**
   - Батч-сохранение приложений
   - SQLite для быстрых запросов (опционально)

4. **Память:**
   - Стриминг при загрузке файлов
   - Обработка данных порциями

5. **Кэширование:**
   - **Кэширование статистики хранилища** (TTL: 5 минут)
   - **Ленивая загрузка** детальной статистики в веб-интерфейсе
   - Снижение нагрузки на файловую систему при частых запросах

6. **Оптимизация веб-интерфейса:**
   - **Легковесный API** для задач (`?lightweight=true`) - уменьшает размер ответа в 4 раза
   - **Параллельная загрузка данных** через `Promise.all()` - ускоряет загрузку страниц в 2.4 раза
   - **Оптимизированное чтение логов** - только последние 8KB файла вместо всего файла
   - **Увеличенный интервал автообновления** - с 5 до 10 секунд для снижения нагрузки

## Безопасность

1. **Аутентификация:**
   - Хранение credentials в переменных окружения (.env)
   - Базовая HTTP аутентификация для API

2. **Валидация данных:**
   - Проверка существования файлов перед загрузкой
   - Валидация размеров файлов

3. **Обработка путей:**
   - Использование os.path.join() для безопасных путей
   - Проверка существования директорий

## Новые возможности (v2.0)

### Детальная статистика хранилища
- Разбивка по категориям (binaries, descriptions, metadata)
- Статистика по дискам
- Размер каждой папки (топ 100 на категорию)
- Кэширование для производительности (TTL: 5 минут)
- Ленивая загрузка в веб-интерфейсе

### Поддержка нескольких учетных записей
- Ротация учетных записей для параллельных запросов
- Автоматическая ротация при rate limiting (429)
- Управление через веб-интерфейс
- Thread-safe реализация
- Обратная совместимость со старым форматом

### Извлечение ссылок на документацию
- Автоматическое извлечение из HTML страниц Marketplace
- Парсинг блока Resources → App documentation
- Сохранение в JSON файлах описаний
- Отображение в веб-интерфейсе как кнопка "Documentation"
- Кнопка документации на странице деталей приложения
- Неактивная кнопка с подсказкой, если ссылка недоступна

### Полнотекстовый поиск по описаниям и Release Notes
- **Многоуровневая система поиска:**
  - Whoosh full-text search (если индекс существует)
  - Enhanced Search (поиск по всем локальным данным)
  - Simple Text Search (fallback для базового поиска)
- **Whoosh поиск:**
  - Использование библиотеки Whoosh для полнотекстового поиска
  - Поиск по всем описаниям: JSON, full page HTML, release notes
  - Автоматическое удаление HTML тегов перед индексацией
  - Поддержка сложных запросов (фразы, wildcards, boolean операторы)
  - Ранжирование результатов по релевантности
  - Подсветка совпадений в результатах
  - Автоматическое перестроение индекса при необходимости
- **Enhanced Search:**
  - Поиск по именам приложений, вендорам, ключам
  - Поиск по категориям и продуктам
  - Поиск в JSON и HTML описаниях
  - Поиск в release notes из базы данных
  - Система взвешенных оценок релевантности
  - Извлечение контекста вокруг совпадений
- Страница поиска `/search` с удобным интерфейсом
- API возвращает информацию о методе поиска, который был использован

### Фильтрация и сортировка таблиц
- **Страница Storage (`/storage`):**
  - Автоматическая фильтрация пустых папок (0 MB, 0 files)
  - Сортировка по клику на заголовки колонок:
    - Folder Path (алфавитный порядок)
    - Drive (алфавитный порядок)
    - Size (числовой, от большего к меньшему)
    - Files (числовой, от большего к меньшему)
    - % of Category (числовой, от большего к меньшему)
  - Поле фильтрации по пути папки или диску
  - Визуальные индикаторы сортировки (стрелки ↑↓)
- **Страница Descriptions (`/descriptions`):**
  - Сортировка по клику на заголовки колонок:
    - App Name (алфавитный порядок)
    - Addon Key (алфавитный порядок)
    - Vendor (алфавитный порядок)
  - Поле фильтрации по названию приложения, ключу или вендору
  - Счетчик отфильтрованных результатов
- **CSS стили:** Добавлены стили для сортируемых таблиц (`.table-sortable`)

### Smoke Tests
- **Комплексный набор тестов** (`tests/test_smoke.py`):
  - Тесты MetadataStore (инициализация, получение данных)
  - Тесты DownloadManager (статистика хранилища)
  - Тесты функциональности поиска (Whoosh, Enhanced)
  - Тесты файловой системы (существование директорий)
  - Тесты настроек (загрузка конфигурации)
  - Тесты структуры статистики хранилища
- **Скрипт запуска тестов** (`run_smoke_tests.py`):
  - Удобный интерфейс командной строки
  - Опция подробного вывода (`--verbose`)
  - Режим быстрых тестов (`--quick`)
  - Детальная отчетность об ошибках
- **Документация** (`tests/README.md`):
  - Полное руководство по запуску тестов
  - Объяснение того, что проверяет каждый тест
  - Руководство по устранению неполадок

### Оптимизация производительности
- Кэширование статистики (TTL: 5 минут)
- Ленивая загрузка детальной статистики (AJAX)
- Ускорение загрузки веб-интерфейса
- Снижение нагрузки на файловую систему
- Индексация для быстрого поиска

## Расширяемость

### Точки расширения:

1. **Новые источники данных:**
   - Добавление новых API клиентов
   - Поддержка других форматов данных

2. **Новые фильтры:**
   - Расширение `scraper/filters.py`
   - Добавление новых критериев фильтрации

3. **Новые хранилища:**
   - Реализация интерфейса MetadataStore
   - Поддержка PostgreSQL, MongoDB и т.д.

4. **Новые форматы экспорта:**
   - CSV, Excel экспорт
   - API для внешних систем

## Зависимости

### Основные библиотеки:
- `flask` — веб-фреймворк
- `flask-wtf` — CSRF защита для Flask
- `requests` — HTTP клиент
- `pandas` — обработка данных (опционально)
- `tqdm` — прогресс-бары
- `python-decouple` — управление конфигурацией
- `beautifulsoup4` — парсинг HTML
- `lxml` — быстрый XML/HTML парсер
- `playwright` — headless браузер для скачивания описаний
- `whoosh` — полнотекстовый поиск
- `cryptography` — шифрование для credentials

## Структура директорий

```
atlassian-marketplace-scraper/
├── app.py                      # Flask приложение
├── run_scraper.py              # CLI: сбор приложений
├── run_version_scraper.py      # CLI: сбор версий
├── run_downloader.py           # CLI: загрузка бинарников
├── run_index_search.py         # CLI: построение поискового индекса
├── config/                     # Конфигурация
│   ├── settings.py             # Настройки
│   └── products.py             # Определение продуктов
├── scraper/                    # Логика скрапинга
│   ├── app_scraper.py
│   ├── version_scraper.py
│   ├── download_manager.py
│   ├── marketplace_api.py
│   ├── marketplace_api_v3.py
│   ├── metadata_store.py
│   └── filters.py
├── models/                     # Модели данных
│   ├── app.py
│   ├── version.py
│   └── download.py
├── utils/                      # Утилиты
│   ├── rate_limiter.py
│   ├── checkpoint.py
│   └── logger.py
├── web/                        # Веб-интерфейс
│   ├── routes.py
│   ├── search_index_whoosh.py  # Поисковый индекс (Whoosh)
│   ├── search_enhanced.py      # Расширенный поиск по всем данным
│   ├── templates/
│   └── static/
├── tests/                      # Тесты
│   ├── test_smoke.py          # Smoke tests
│   ├── test_search_api.py     # API-level search tests
│   └── README.md              # Документация по тестам
├── run_smoke_tests.py         # Скрипт запуска smoke tests
├── data/                       # Данные
│   ├── metadata/               # Метаданные (JSON/SQLite)
│   └── binaries/               # Бинарные файлы
└── logs/                       # Логи
```

## Заключение

Проект использует модульную архитектуру с четким разделением ответственности:
- **Слой скрапинга** — сбор данных
- **Слой данных** — хранение и управление данными
- **Веб-слой** — представление данных пользователю
- **Утилиты** — вспомогательные функции

Такая архитектура обеспечивает:
- Легкость тестирования
- Возможность расширения
- Поддержку и развитие
- Переиспользование компонентов

