{% extends "base.html" %}

{% block title %}Storage Details - Atlassian Marketplace Scraper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-hdd-stack"></i> Storage Details</h2>
        <p class="text-muted">Detailed breakdown of storage usage by category, disk, and folders</p>
    </div>
</div>

<!-- Loading Indicator -->
<div id="storage-loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Calculating storage statistics...</p>
    <small class="text-muted">This may take a few seconds if you have many files.</small>
</div>

<!-- Content Container (hidden until loaded) -->
<div id="storage-content" style="display: none;">
<!-- Total Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Total Storage</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h3 id="storage-total-size">-</h3>
                        <small class="text-muted">Total Size</small>
                    </div>
                    <div class="col-md-3">
                        <h3 id="storage-total-files">-</h3>
                        <small class="text-muted">Total Files</small>
                    </div>
                    <div class="col-md-6">
                        <h6>By Disk:</h6>
                        <div class="d-flex flex-wrap gap-2" id="storage-by-disk">
                            <!-- Will be populated via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories Breakdown -->
<div class="row mb-4" id="storage-categories">
    <!-- Will be populated via JavaScript -->
</div>

<!-- Detailed Folders Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> All Folders by Category</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="categoryTabs" role="tablist">
                    <!-- Will be populated via JavaScript -->
                </ul>
                <div class="tab-content mt-3" id="categoryTabContent">
                    <!-- Will be populated via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- No Storage Data Message (hidden by default) -->
<div id="storage-empty" style="display: none;">
    <div class="alert alert-info">
        <h5 class="alert-heading">No Storage Data</h5>
        <p>Storage statistics are not available yet.</p>
    </div>
</div>

<script>
// Load storage details on page load (lazy loading)
document.addEventListener('DOMContentLoaded', function() {
    const loadingDiv = document.getElementById('storage-loading');
    const contentDiv = document.getElementById('storage-content');
    const emptyDiv = document.getElementById('storage-empty');
    
    fetch('/api/storage-stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                loadingDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                return;
            }
            
            if (!data || !data.total || data.total.file_count === 0) {
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }
            
            // Update total summary
            const totalSizeEl = document.getElementById('storage-total-size');
            if (totalSizeEl) {
                totalSizeEl.textContent = data.total.gb >= 1.0 ? 
                    data.total.gb.toFixed(2) + ' GB' : 
                    Math.round(data.total.mb) + ' MB';
            }
            
            const totalFilesEl = document.getElementById('storage-total-files');
            if (totalFilesEl) {
                totalFilesEl.textContent = data.total.file_count;
            }
            
            // Update by disk badges
            const byDiskContainer = document.getElementById('storage-by-disk');
            if (byDiskContainer && data.by_disk) {
                byDiskContainer.innerHTML = Object.entries(data.by_disk).map(([drive, diskData]) => {
                    const size = diskData.gb >= 1.0 ? 
                        diskData.gb.toFixed(2) + ' GB' : 
                        Math.round(diskData.mb) + ' MB';
                    return `<span class="badge bg-secondary">
                        <strong>${drive}</strong>: ${size} (${diskData.file_count} files)
                    </span>`;
                }).join('');
            }
            
            // Render categories
            const categoriesContainer = document.getElementById('storage-categories');
            const tabsContainer = document.getElementById('categoryTabs');
            const tabsContentContainer = document.getElementById('categoryTabContent');
            
            if (categoriesContainer && data.categories) {
                // Render category cards
                categoriesContainer.innerHTML = Object.entries(data.categories).map(([category, catData]) => {
                    const size = catData.gb >= 1.0 ? 
                        catData.gb.toFixed(2) + ' GB' : 
                        Math.round(catData.mb) + ' MB';
                    
                    let byDiskHtml = '';
                    if (catData.by_disk) {
                        byDiskHtml = '<div class="mb-3"><h6>By Disk:</h6><ul class="list-unstyled">';
                        byDiskHtml += Object.entries(catData.by_disk).map(([drive, diskData]) => {
                            const diskSize = diskData.gb >= 1.0 ? 
                                diskData.gb.toFixed(2) + ' GB' : 
                                Math.round(diskData.mb) + ' MB';
                            return `<li class="mb-1">
                                <strong>${drive}</strong>: ${diskSize}
                                <small class="text-muted">(${diskData.file_count} files)</small>
                            </li>`;
                        }).join('');
                        byDiskHtml += '</ul></div>';
                    }
                    
                    let foldersHtml = '';
                    if (catData.folders && catData.folders.length > 0) {
                        foldersHtml = '<div><h6>Top Folders:</h6><div class="table-responsive" style="max-height: 300px; overflow-y: auto;"><table class="table table-sm table-hover"><thead><tr><th>Folder</th><th class="text-end">Size</th><th class="text-end">Files</th></tr></thead><tbody>';
                        foldersHtml += catData.folders.slice(0, 20).map(folder => {
                            const folderSize = folder.gb >= 1.0 ? 
                                folder.gb.toFixed(2) + ' GB' : 
                                Math.round(folder.mb) + ' MB';
                            return `<tr>
                                <td><code class="small">${escapeHtml(folder.name)}</code><br><small class="text-muted">${escapeHtml(folder.path)}</small></td>
                                <td class="text-end">${folderSize}</td>
                                <td class="text-end">${folder.file_count}</td>
                            </tr>`;
                        }).join('');
                        foldersHtml += '</tbody></table></div>';
                        if (catData.folders.length > 20) {
                            foldersHtml += `<small class="text-muted">Showing top 20 folders (${catData.folders.length} total)</small>`;
                        }
                        foldersHtml += '</div>';
                    }
                    
                    return `<div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0 text-capitalize">
                                    <i class="bi bi-folder"></i> ${escapeHtml(category)}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h3>${size}</h3>
                                    <small class="text-muted">${catData.file_count} files</small>
                                </div>
                                ${byDiskHtml}
                                ${foldersHtml}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            // Render tabs
            if (tabsContainer && tabsContentContainer && data.categories) {
                const categories = Object.keys(data.categories);
                tabsContainer.innerHTML = categories.map((category, index) => 
                    `<li class="nav-item" role="presentation">
                        <button class="nav-link ${index === 0 ? 'active' : ''}" 
                                id="${category}-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#${category}" 
                                type="button" 
                                role="tab">
                            ${category.charAt(0).toUpperCase() + category.slice(1)}
                        </button>
                    </li>`
                ).join('');
                
                tabsContentContainer.innerHTML = categories.map((category, index) => {
                    const catData = data.categories[category];
                    const rows = catData.folders.map(folder => {
                        const folderSize = folder.gb >= 1.0 ? 
                            folder.gb.toFixed(2) + ' GB' : 
                            Math.round(folder.mb) + ' MB';
                        const percent = catData.bytes > 0 ? 
                            ((folder.bytes / catData.bytes) * 100).toFixed(1) : 
                            '0';
                        return `<tr>
                            <td><code>${escapeHtml(folder.path)}</code></td>
                            <td><span class="badge bg-secondary">${escapeHtml(folder.drive)}</span></td>
                            <td class="text-end">${folderSize}</td>
                            <td class="text-end">${folder.file_count}</td>
                            <td class="text-end">${percent}%</td>
                        </tr>`;
                    }).join('');
                    
                    return `<div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                         id="${category}" 
                         role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Folder Path</th>
                                        <th>Drive</th>
                                        <th class="text-end">Size</th>
                                        <th class="text-end">Files</th>
                                        <th class="text-end">% of Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }).join('');
            }
            
            // Hide loading, show content
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading storage details:', error);
            loadingDiv.innerHTML = `<div class="alert alert-danger">Error loading storage statistics: ${error.message}</div>`;
        });
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}

