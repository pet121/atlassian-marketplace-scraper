{% extends "base.html" %}

{% block title %}Management - Atlassian Marketplace Scraper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-gear"></i> Management & Control</h2>
        <p class="text-muted">Manage scraper tasks and settings</p>
    </div>
</div>

<!-- Task Control Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-play-circle"></i> Task Control</h5>
            </div>
            <div class="card-body">
                <!-- Full Pipeline -->
                <div class="mb-4 p-4 border rounded bg-light">
                    <h5 class="mb-3">
                        <i class="bi bi-play-circle-fill text-primary"></i> 
                        Full Pipeline (Run All Tasks Sequentially)
                    </h5>
                    <p class="text-muted">
                        <strong>One-click automation:</strong> Run all tasks in sequence (Scrape Apps → Versions → Binaries → Descriptions).
                        Perfect for overnight runs - start it and go to sleep!
                    </p>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pipeline-resume-scrape">
                                <label class="form-check-label" for="pipeline-resume-scrape">
                                    Resume app scraping from checkpoint
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="pipeline-download-product" class="form-label">Product filter (optional):</label>
                            <select id="pipeline-download-product" class="form-select form-select-sm">
                                <option value="">All Products</option>
                                {% for product in products %}
                                <option value="{{ product }}">{{ product|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="pipeline-download-media" checked>
                                <label class="form-check-label" for="pipeline-download-media">
                                    Download media files (images/videos)
                                </label>
                            </div>
                        </div>
                    </div>
                    <button id="btn-pipeline" class="btn btn-lg btn-primary" onclick="startPipeline()">
                        <i class="bi bi-rocket-takeoff"></i> Start Full Pipeline
                    </button>
                    <div id="status-pipeline" class="mt-3"></div>
                    <div id="pipeline-progress" class="mt-3" style="display: none;">
                        <div class="progress" style="height: 30px;">
                            <div id="pipeline-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">
                                <span id="pipeline-progress-text">0%</span>
                            </div>
                        </div>
                        <div id="pipeline-steps" class="mt-2 small"></div>
                    </div>
                </div>

                <hr class="my-4">

                <h6 class="text-muted mb-3">Individual Tasks:</h6>

                <!-- Scrape Apps Task -->
                <div class="mb-4 p-3 border rounded">
                    <h6><i class="bi bi-collection"></i> 1. Scrape Apps</h6>
                    <p class="text-muted small">Collect all apps from Atlassian Marketplace</p>
                    <div class="d-flex gap-2 mb-2">
                        <button id="btn-scrape-apps" class="btn btn-primary" onclick="startScrapeApps(false)">
                            <i class="bi bi-play-fill"></i> Start Fresh
                        </button>
                        <button id="btn-scrape-apps-resume" class="btn btn-outline-primary" onclick="startScrapeApps(true)">
                            <i class="bi bi-arrow-clockwise"></i> Resume
                        </button>
                    </div>
                    <div id="status-scrape-apps" class="mt-2"></div>
                </div>

                <!-- Scrape Versions Task -->
                <div class="mb-4 p-3 border rounded">
                    <h6><i class="bi bi-tags"></i> 2. Scrape Versions</h6>
                    <p class="text-muted small">Collect version information for all apps</p>
                    <button id="btn-scrape-versions" class="btn btn-success" onclick="startScrapeVersions()">
                        <i class="bi bi-play-fill"></i> Start
                    </button>
                    <div id="status-scrape-versions" class="mt-2"></div>
                </div>

                <!-- Download Binaries Task -->
                <div class="mb-4 p-3 border rounded">
                    <h6><i class="bi bi-download"></i> 3. Download Binaries</h6>
                    <p class="text-muted small">Download JAR/OBR files for all versions</p>
                    <div class="mb-2">
                        <label for="download-product" class="form-label">Product (optional):</label>
                        <select id="download-product" class="form-select form-select-sm" style="max-width: 200px;">
                            <option value="">All Products</option>
                            {% for product in products %}
                            <option value="{{ product }}">{{ product|title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="btn-download" class="btn btn-warning" onclick="startDownload()">
                        <i class="bi bi-play-fill"></i> Start Download
                    </button>
                    <div id="status-download" class="mt-2"></div>
                </div>

                <!-- Download Descriptions Task -->
                <div class="mb-4 p-3 border rounded">
                    <h6><i class="bi bi-file-text"></i> 4. Download Descriptions</h6>
                    <p class="text-muted small">Download plugin descriptions with images and videos from Marketplace pages</p>
                    <div class="mb-2">
                        <label for="description-addon-key" class="form-label">Addon Key (optional, leave empty for all):</label>
                        <input type="text" id="description-addon-key" class="form-control form-control-sm" style="max-width: 300px;" placeholder="com.example.plugin">
                    </div>
                    <div class="mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="description-download-media" checked>
                            <label class="form-check-label" for="description-download-media">
                                Download media files (images/videos)
                            </label>
                        </div>
                    </div>
                    <button id="btn-download-descriptions" class="btn btn-info" onclick="startDownloadDescriptions()">
                        <i class="bi bi-play-fill"></i> Start Description Download
                    </button>
                    <div id="status-download-descriptions" class="mt-2"></div>
                </div>

                <!-- Build Search Index Task -->
                <div class="mb-4 p-3 border rounded">
                    <h6><i class="bi bi-search"></i> 5. Build Search Index</h6>
                    <p class="text-muted small">Build or rebuild the full-text search index for plugin descriptions and release notes</p>
                    <p class="text-muted small">
                        <i class="bi bi-info-circle"></i> 
                        This will index all descriptions (JSON, HTML) and release notes. 
                        The index is used for fast searching on the Search page.
                    </p>
                    <button id="btn-build-index" class="btn btn-primary" onclick="startBuildIndex()">
                        <i class="bi bi-play-fill"></i> Build Search Index
                    </button>
                    <div id="status-build-index" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Storage Paths Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-folder"></i> Storage Paths</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Note:</strong> Configure where files are stored. You can specify different drives for different types of data.
                    Changes require application restart to take effect.
                </div>
                
                <form id="storage-paths-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-database"></i> Metadata & Database</h6>
                            
                            <div class="mb-3">
                                <label for="metadata_dir" class="form-label">Metadata Directory</label>
                                <input type="text" class="form-control" id="metadata_dir" 
                                       value="{{ storage_paths.METADATA_DIR }}" 
                                       placeholder="I:\marketplace\metadata">
                                <small class="text-muted">Where metadata (apps.json, versions) are stored</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="database_path" class="form-label">Database Path</label>
                                <input type="text" class="form-control" id="database_path" 
                                       value="{{ storage_paths.DATABASE_PATH }}" 
                                       placeholder="I:\marketplace\marketplace.db">
                                <small class="text-muted">SQLite database file location</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="descriptions_dir" class="form-label">Descriptions Directory</label>
                                <input type="text" class="form-control" id="descriptions_dir" 
                                       value="{{ storage_paths.DESCRIPTIONS_DIR }}" 
                                       placeholder="K:\marketplace-descriptions">
                                <small class="text-muted">Where plugin descriptions (HTML, images, videos) are stored</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="logs_dir" class="form-label">Logs Directory</label>
                                <input type="text" class="form-control" id="logs_dir" 
                                       value="{{ storage_paths.LOGS_DIR }}" 
                                       placeholder="I:\marketplace\logs">
                                <small class="text-muted">Where log files are stored</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-success mb-3"><i class="bi bi-hdd"></i> Binary Files (by Product)</h6>
                            
                            <div class="mb-3">
                                <label for="binaries_base_dir" class="form-label">Base Binaries Directory</label>
                                <input type="text" class="form-control" id="binaries_base_dir" 
                                       value="{{ storage_paths.BINARIES_BASE_DIR }}" 
                                       placeholder="H:\marketplace-binaries">
                                <small class="text-muted">Default directory for binaries (used as fallback)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="binaries_dir_jira" class="form-label">Jira Binaries</label>
                                <input type="text" class="form-control" id="binaries_dir_jira" 
                                       value="{{ storage_paths.BINARIES_DIR_JIRA }}" 
                                       placeholder="H:\marketplace-binaries\jira">
                                <small class="text-muted">Jira plugin binaries (JAR files)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="binaries_dir_confluence" class="form-label">Confluence Binaries</label>
                                <input type="text" class="form-control" id="binaries_dir_confluence" 
                                       value="{{ storage_paths.BINARIES_DIR_CONFLUENCE }}" 
                                       placeholder="K:\marketplace-binaries\confluence">
                                <small class="text-muted">Confluence plugin binaries</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="binaries_dir_bitbucket" class="form-label">Bitbucket Binaries</label>
                                <input type="text" class="form-control" id="binaries_dir_bitbucket" 
                                       value="{{ storage_paths.BINARIES_DIR_BITBUCKET }}" 
                                       placeholder="V:\marketplace-binaries\bitbucket">
                                <small class="text-muted">Bitbucket plugin binaries</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="binaries_dir_bamboo" class="form-label">Bamboo Binaries</label>
                                <input type="text" class="form-control" id="binaries_dir_bamboo" 
                                       value="{{ storage_paths.BINARIES_DIR_BAMBOO }}" 
                                       placeholder="W:\marketplace-binaries\bamboo">
                                <small class="text-muted">Bamboo plugin binaries</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="binaries_dir_crowd" class="form-label">Crowd Binaries</label>
                                <input type="text" class="form-control" id="binaries_dir_crowd" 
                                       value="{{ storage_paths.BINARIES_DIR_CROWD }}" 
                                       placeholder="F:\marketplace-binaries\crowd">
                                <small class="text-muted">Crowd plugin binaries</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveStoragePaths()">
                            <i class="bi bi-save"></i> Save Storage Paths
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadStoragePaths()">
                            <i class="bi bi-arrow-clockwise"></i> Reload
                        </button>
                    </div>
                    <div id="storage-paths-message" class="mt-2"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Credentials Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-key"></i> Marketplace API Credentials</h5>
                <span id="credentials-count-badge" class="badge bg-dark">Loading...</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Note:</strong> Credentials are stored in <code>.credentials.json</code> (not in .env file) 
                    so they won't be committed to git. You can add multiple accounts for parallel requests and automatic rotation.
                    <br><strong>Multiple accounts:</strong> When you have 2+ accounts, the system will automatically rotate between them to avoid rate limits.
                </div>
                
                <!-- Accounts List -->
                <div id="accounts-list" class="mb-3">
                    <h6>Configured Accounts:</h6>
                    <div id="accounts-container">
                        <!-- Accounts will be loaded here -->
                    </div>
                </div>
                
                <!-- Add New Account Form -->
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Add/Update Account</h6>
                    </div>
                    <div class="card-body">
                        <form id="credentials-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="credentials_username" class="form-label">Username (Email)</label>
                                        <input type="email" class="form-control" id="credentials_username" 
                                               placeholder="your-email@example.com">
                                        <small class="text-muted">Your Atlassian account email</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="credentials_api_token" class="form-label">API Token</label>
                                        <input type="password" class="form-control" id="credentials_api_token" 
                                               placeholder="Enter API token">
                                        <small class="text-muted">API token from Atlassian (stored securely)</small>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addAccount()">
                                <i class="bi bi-plus-circle"></i> Add Account
                            </button>
                            <div id="credentials-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Settings</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Note:</strong> To change settings, edit the <code>.env</code> file and restart the application.
                    Current values are shown below for reference.
                </div>
                
                <form id="settings-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scraper_batch_size" class="form-label">Scraper Batch Size</label>
                                <input type="number" class="form-control" id="scraper_batch_size" 
                                       value="{{ current_settings.SCRAPER_BATCH_SIZE }}" min="1" max="100">
                                <small class="text-muted">Apps per API request (default: 50)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="scraper_request_delay" class="form-label">Request Delay (seconds)</label>
                                <input type="number" class="form-control" id="scraper_request_delay" 
                                       value="{{ current_settings.SCRAPER_REQUEST_DELAY }}" step="0.1" min="0.1">
                                <small class="text-muted">Delay between API requests (default: 0.5)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="version_age_limit_days" class="form-label">Version Age Limit (days)</label>
                                <input type="number" class="form-control" id="version_age_limit_days" 
                                       value="{{ current_settings.VERSION_AGE_LIMIT_DAYS }}" min="0">
                                <small class="text-muted">Only versions from last N days (0 = all versions)</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_concurrent_downloads" class="form-label">Max Concurrent Downloads</label>
                                <input type="number" class="form-control" id="max_concurrent_downloads" 
                                       value="{{ current_settings.MAX_CONCURRENT_DOWNLOADS }}" min="1" max="10">
                                <small class="text-muted">Parallel download threads (default: 3)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="max_version_scraper_workers" class="form-label">Version Scraper Workers</label>
                                <input type="number" class="form-control" id="max_version_scraper_workers" 
                                       value="{{ current_settings.MAX_VERSION_SCRAPER_WORKERS }}" min="1" max="20">
                                <small class="text-muted">Parallel workers for version scraping (default: 10)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="max_retry_attempts" class="form-label">Max Retry Attempts</label>
                                <input type="number" class="form-control" id="max_retry_attempts" 
                                       value="{{ current_settings.MAX_RETRY_ATTEMPTS }}" min="1" max="10">
                                <small class="text-muted">Retry attempts for failed requests (default: 3)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showSettingsNote()">
                            <i class="bi bi-info-circle"></i> Info
                        </button>
                    </div>
                    <div id="settings-message" class="mt-2"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Task History -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Task Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshTaskStatus()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearCompletedTasks()" title="Clear all completed, failed, and cancelled tasks">
                            <i class="bi bi-trash"></i> Clear Completed
                        </button>
                    </div>
                    <small class="text-muted" id="last-update-time">Last update: --</small>
                </div>
                
                <!-- Tabs for task statuses -->
                <ul class="nav nav-tabs mb-3" id="task-status-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-tasks" type="button" role="tab">
                            All
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="running-tab" data-bs-toggle="tab" data-bs-target="#running-tasks" type="button" role="tab">
                            Running
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab">
                            Completed
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="failed-tab" data-bs-toggle="tab" data-bs-target="#failed-tasks" type="button" role="tab">
                            Failed
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled-tasks" type="button" role="tab">
                            Cancelled
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="task-status-tab-content">
                    <div class="tab-pane fade show active" id="all-tasks" role="tabpanel">
                        <div id="task-status-container-all" style="min-height: 200px;">
                            <p class="text-muted">Loading task status...</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="running-tasks" role="tabpanel">
                        <div id="task-status-container-running" style="min-height: 200px;">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="completed-tasks" role="tabpanel">
                        <div id="task-status-container-completed" style="min-height: 200px;">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="failed-tasks" role="tabpanel">
                        <div id="task-status-container-failed" style="min-height: 200px;">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="cancelled-tasks" role="tabpanel">
                        <div id="task-status-container-cancelled" style="min-height: 200px;">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-file-text"></i> View Logs</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="log-file-select" class="form-label">Select Log File:</label>
                    <select class="form-select" id="log-file-select" onchange="loadLogFile()">
                        <option value="">-- Select a log file --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="log-lines" class="form-label">Number of lines:</label>
                    <input type="number" class="form-control" id="log-lines" value="500" min="100" max="5000" step="100">
                </div>
                <button class="btn btn-info" onclick="loadLogFile()">
                    <i class="bi bi-arrow-clockwise"></i> Load Log
                </button>
                <div id="log-content-container" class="mt-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted" id="log-info"></small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyLogContent()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <pre id="log-content" class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Task management functions
function startScrapeApps(resume) {
    const btn = document.getElementById('btn-scrape-apps');
    const statusDiv = document.getElementById('status-scrape-apps');
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Starting...';
    
    fetchWithCSRF('/api/tasks/start/scrape-apps', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({resume: resume})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['scrape-apps'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Task started: ${data.task_id}</div>`;
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        btn.disabled = false;
    });
}

function startScrapeVersions() {
    const btn = document.getElementById('btn-scrape-versions');
    const statusDiv = document.getElementById('status-scrape-versions');
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Starting...';
    
    fetchWithCSRF('/api/tasks/start/scrape-versions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['scrape-versions'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Task started: ${data.task_id}</div>`;
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        btn.disabled = false;
    });
}

// Track active task IDs for each button type
const activeTaskIds = {
    'download': null,
    'download-descriptions': null,
    'scrape-apps': null,
    'scrape-versions': null,
    'pipeline': null,
    'build-index': null
};

function startDownload() {
    const btn = document.getElementById('btn-download');
    const statusDiv = document.getElementById('status-download');
    const product = document.getElementById('download-product').value;
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Starting...';
    
    fetchWithCSRF('/api/tasks/start/download', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({product: product || null})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['download'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Task started: ${data.task_id}</div>`;
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        btn.disabled = false;
    });
}

function startDownloadDescriptions() {
    const btn = document.getElementById('btn-download-descriptions');
    const statusDiv = document.getElementById('status-download-descriptions');
    const addonKey = document.getElementById('description-addon-key').value.trim();
    const downloadMedia = document.getElementById('description-download-media').checked;
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Starting...';
    
    fetchWithCSRF('/api/tasks/start/download-descriptions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            addon_key: addonKey || null,
            download_media: downloadMedia
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['download-descriptions'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Task started: ${data.task_id}</div>`;
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        btn.disabled = false;
    });
}

// Old refreshTaskStatus function removed - using new version with tabs and logs below

function saveSettings() {
    const messageDiv = document.getElementById('settings-message');
    messageDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Saving...';
    
    const settings = {
        SCRAPER_BATCH_SIZE: document.getElementById('scraper_batch_size').value,
        SCRAPER_REQUEST_DELAY: document.getElementById('scraper_request_delay').value,
        VERSION_AGE_LIMIT_DAYS: document.getElementById('version_age_limit_days').value,
        MAX_CONCURRENT_DOWNLOADS: document.getElementById('max_concurrent_downloads').value,
        MAX_VERSION_SCRAPER_WORKERS: document.getElementById('max_version_scraper_workers').value,
        MAX_RETRY_ATTEMPTS: document.getElementById('max_retry_attempts').value
    };
    
    fetchWithCSRF('/api/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
        } else {
            const errors = data.errors ? data.errors.join('<br>') : data.error;
            messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${errors}</div>`;
        }
    })
    .catch(e => {
        messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    });
}

function startBuildIndex() {
    const btn = document.getElementById('btn-build-index');
    const statusDiv = document.getElementById('status-build-index');
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Starting...';
    
    fetchWithCSRF('/api/tasks/start/build-index', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['build-index'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Task started: ${data.task_id}</div>`;
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        btn.disabled = false;
    });
}

function startPipeline() {
    const btn = document.getElementById('btn-pipeline');
    const statusDiv = document.getElementById('status-pipeline');
    const progressDiv = document.getElementById('pipeline-progress');
    const progressBar = document.getElementById('pipeline-progress-bar');
    const progressText = document.getElementById('pipeline-progress-text');
    const stepsDiv = document.getElementById('pipeline-steps');
    
    const resumeScrape = document.getElementById('pipeline-resume-scrape').checked;
    const downloadProduct = document.getElementById('pipeline-download-product').value;
    const downloadMedia = document.getElementById('pipeline-download-media').checked;
    
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Starting pipeline...</div>';
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0% - Starting...';
    stepsDiv.innerHTML = '';
    
    fetchWithCSRF('/api/tasks/start/pipeline', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            resume_scrape: resumeScrape,
            download_product: downloadProduct || null,
            download_media: downloadMedia
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            activeTaskIds['pipeline'] = data.task_id;
            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Pipeline started: ${data.task_id}</div>`;
            
            // Start polling for progress
            let pollInterval = setInterval(() => {
                fetch(`/api/tasks/${data.task_id}`)
                .then(r => r.json())
                .then(statusData => {
                    if (statusData.success && statusData.task) {
                        const task = statusData.task;
                        const progress = task.progress || 0;
                        const currentStep = task.current_step || 0;
                        const totalSteps = task.total_steps || 4;
                        
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${progress}% - ${task.message || 'Running...'}`;
                        
                        // Update steps
                        if (task.steps && task.steps.length > 0) {
                            let stepsHtml = '<strong>Steps:</strong><ul class="mb-0">';
                            task.steps.forEach((step, idx) => {
                                const statusIcon = step.status === 'completed' ? '✅' : 
                                                  step.status === 'failed' ? '❌' : 
                                                  step.status === 'running' ? '⏳' : '⏸️';
                                stepsHtml += `<li>${statusIcon} ${step.name}</li>`;
                            });
                            stepsHtml += '</ul>';
                            stepsDiv.innerHTML = stepsHtml;
                        }
                        
                        if (task.status === 'completed') {
                            clearInterval(pollInterval);
                            progressBar.classList.remove('progress-bar-animated');
                            progressBar.classList.add('bg-success');
                            statusDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle-fill"></i> Pipeline completed successfully!</div>`;
                            btn.disabled = false;
                        } else if (task.status === 'failed') {
                            clearInterval(pollInterval);
                            progressBar.classList.remove('progress-bar-animated');
                            progressBar.classList.add('bg-danger');
                            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Pipeline failed: ${task.message || 'Unknown error'}</div>`;
                            btn.disabled = false;
                        }
                    }
                })
                .catch(e => {
                    console.error('Error polling pipeline status:', e);
                });
            }, 3000); // Poll every 3 seconds
            
            // Stop polling after 24 hours (safety)
            setTimeout(() => clearInterval(pollInterval), 24 * 60 * 60 * 1000);
            
            setTimeout(() => refreshTaskStatus(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            progressDiv.style.display = 'none';
            btn.disabled = false;
        }
    })
    .catch(e => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
        progressDiv.style.display = 'none';
        btn.disabled = false;
    });
}

function showSettingsNote() {
    alert('Settings Information:\n\n' +
          '• Settings are saved to .env file\n' +
          '• You need to restart the Flask application for changes to take effect\n' +
          '• Current values are shown from .env file\n' +
          '• Some settings may require restarting running tasks');
}

function saveStoragePaths() {
    const messageDiv = document.getElementById('storage-paths-message');
    messageDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Saving...';
    
    const paths = {
        METADATA_DIR: document.getElementById('metadata_dir').value.trim(),
        DATABASE_PATH: document.getElementById('database_path').value.trim(),
        DESCRIPTIONS_DIR: document.getElementById('descriptions_dir').value.trim(),
        LOGS_DIR: document.getElementById('logs_dir').value.trim(),
        BINARIES_BASE_DIR: document.getElementById('binaries_base_dir').value.trim(),
        BINARIES_DIR_JIRA: document.getElementById('binaries_dir_jira').value.trim(),
        BINARIES_DIR_CONFLUENCE: document.getElementById('binaries_dir_confluence').value.trim(),
        BINARIES_DIR_BITBUCKET: document.getElementById('binaries_dir_bitbucket').value.trim(),
        BINARIES_DIR_BAMBOO: document.getElementById('binaries_dir_bamboo').value.trim(),
        BINARIES_DIR_CROWD: document.getElementById('binaries_dir_crowd').value.trim()
    };
    
    fetchWithCSRF('/api/storage-paths', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(paths)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
            if (data.note) {
                messageDiv.innerHTML += `<div class="alert alert-warning mt-2"><i class="bi bi-exclamation-triangle"></i> ${data.note}</div>`;
            }
        } else {
            const errors = data.errors ? data.errors.join('<br>') : data.error;
            messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${errors}</div>`;
        }
    })
    .catch(e => {
        messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    });
}

function loadStoragePaths() {
    const messageDiv = document.getElementById('storage-paths-message');
    messageDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Loading...';
    
    fetchWithCSRF('/api/storage-paths')
    .then(r => r.json())
    .then(data => {
        if (data.success && data.paths) {
            const paths = data.paths;
            document.getElementById('metadata_dir').value = paths.METADATA_DIR || '';
            document.getElementById('database_path').value = paths.DATABASE_PATH || '';
            document.getElementById('descriptions_dir').value = paths.DESCRIPTIONS_DIR || '';
            document.getElementById('logs_dir').value = paths.LOGS_DIR || '';
            document.getElementById('binaries_base_dir').value = paths.BINARIES_BASE_DIR || '';
            document.getElementById('binaries_dir_jira').value = paths.BINARIES_DIR_JIRA || '';
            document.getElementById('binaries_dir_confluence').value = paths.BINARIES_DIR_CONFLUENCE || '';
            document.getElementById('binaries_dir_bitbucket').value = paths.BINARIES_DIR_BITBUCKET || '';
            document.getElementById('binaries_dir_bamboo').value = paths.BINARIES_DIR_BAMBOO || '';
            document.getElementById('binaries_dir_crowd').value = paths.BINARIES_DIR_CROWD || '';
            
            messageDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Paths reloaded successfully</div>';
        } else {
            messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error || 'Failed to load paths'}</div>`;
        }
    })
    .catch(e => {
        messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showTaskError(taskId) {
    fetch(`/api/tasks/${taskId}`)
    .then(r => r.json())
    .then(data => {
        if (data.success && data.task) {
            const task = data.task;
            let errorContent = '';
            
            if (task.error) {
                errorContent += `<h6>Error Output:</h6><pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">${escapeHtml(task.error)}</pre>`;
            }
            if (task.output) {
                errorContent += `<h6 class="mt-3">Output:</h6><pre class="bg-light p-3" style="max-height: 200px; overflow-y: auto;">${escapeHtml(task.output)}</pre>`;
            }
            if (!errorContent) {
                errorContent = '<p class="text-muted">No detailed error information available.</p>';
            }
            
            const modalHtml = `
                <div class="modal fade" id="errorModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">Task Error Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Task ID:</strong> <code>${taskId}</code></p>
                                <p><strong>Script:</strong> ${task.script || 'N/A'}</p>
                                <p><strong>Status:</strong> <span class="badge bg-danger">${task.status}</span></p>
                                <p><strong>Return Code:</strong> ${task.return_code || 'N/A'}</p>
                                <hr>
                                ${errorContent}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('errorModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        } else {
            alert('Could not load task details');
        }
    })
    .catch(e => {
        alert('Error loading task details: ' + e.message);
    });
}

// Credentials functions
function loadAccounts() {
    fetchWithCSRF('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('accounts-container');
                const badge = document.getElementById('credentials-count-badge');
                
                badge.textContent = `${data.count} account(s)`;
                if (data.rotation_enabled) {
                    badge.className = 'badge bg-success';
                    badge.title = 'Rotation enabled - accounts will be rotated automatically';
                } else {
                    badge.className = 'badge bg-secondary';
                    badge.title = 'Single account - add more for rotation';
                }
                
                if (data.accounts && data.accounts.length > 0) {
                    container.innerHTML = data.accounts.map((acc, index) => `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${acc.username || '(No username)'}</strong>
                                        <br><small class="text-muted">Token: ${acc.api_token || 'Not set'}</small>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="removeAccount(${index})">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="alert alert-warning">No accounts configured. Add an account below.</div>';
                }
            }
        })
        .catch(error => {
            console.error('Error loading accounts:', error);
        });
}

function addAccount() {
    const username = document.getElementById('credentials_username').value.trim();
    const apiToken = document.getElementById('credentials_api_token').value.trim();
    const messageDiv = document.getElementById('credentials-message');
    
    if (!username || !apiToken) {
        messageDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Please fill in both username and API token</div>';
        return;
    }
    
    messageDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Saving...';
    
    // Get current accounts
    fetchWithCSRF('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const accounts = data.accounts || [];
                // Check if account already exists
                const existingIndex = accounts.findIndex(acc => acc.username === username);
                if (existingIndex >= 0) {
                    accounts[existingIndex].api_token = apiToken;
                } else {
                    accounts.push({ username: username, api_token: apiToken });
                }
                
                // Save all accounts
                fetchWithCSRF('/api/credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accounts: accounts
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        messageDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${result.message}</div>`;
                        document.getElementById('credentials_username').value = '';
                        document.getElementById('credentials_api_token').value = '';
                        loadAccounts();
                    } else {
                        messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${result.error || 'Failed to save credentials'}</div>`;
                    }
                })
                .catch(error => {
                    messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</div>`;
                });
            }
        })
        .catch(error => {
            messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</div>`;
        });
}

function removeAccount(index) {
    if (!confirm('Are you sure you want to remove this account?')) {
        return;
    }
    
    fetchWithCSRF('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const accounts = data.accounts || [];
                if (index >= 0 && index < accounts.length) {
                    accounts.splice(index, 1);
                    
                    fetchWithCSRF('/api/credentials', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            accounts: accounts
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            loadAccounts();
                        } else {
                            alert('Failed to remove account: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        alert('Error removing account: ' + error.message);
                    });
                }
            }
        })
        .catch(error => {
            alert('Error loading accounts: ' + error.message);
        });
}

// Load accounts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
});

// Logs functions
function loadLogFiles() {
    fetchWithCSRF('/api/logs')
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('log-file-select');
            select.innerHTML = '<option value="">-- Select a log file --</option>';
            data.logs.forEach(log => {
                const sizeKB = (log.size / 1024).toFixed(2);
                const option = document.createElement('option');
                option.value = log.name;
                option.textContent = `${log.name} (${sizeKB} KB)`;
                select.appendChild(option);
            });
        }
    })
    .catch(e => console.error('Error loading logs:', e));
}

function loadLogFile() {
    const logName = document.getElementById('log-file-select').value;
    const lines = document.getElementById('log-lines').value;
    const container = document.getElementById('log-content-container');
    const contentDiv = document.getElementById('log-content');
    const infoDiv = document.getElementById('log-info');
    
    if (!logName) {
        container.style.display = 'none';
        return;
    }
    
    contentDiv.textContent = 'Loading...';
    container.style.display = 'block';
    
    fetch(`/api/logs/${logName}?lines=${lines}`)
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            contentDiv.textContent = data.content;
            infoDiv.textContent = `Showing last ${data.showing} of ${data.total_lines} lines`;
        } else {
            contentDiv.textContent = `Error: ${data.error}`;
        }
    })
    .catch(e => {
        contentDiv.textContent = `Error: ${e.message}`;
    });
}

function copyLogContent() {
    const content = document.getElementById('log-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Log content copied to clipboard');
    }).catch(e => {
        alert('Failed to copy: ' + e.message);
    });
}

// Cancel task function
function cancelTask(taskId) {
    if (!confirm(`Are you sure you want to cancel task ${taskId.substring(0, 20)}...?`)) {
        return;
    }
    
    fetchWithCSRF(`/api/tasks/${taskId}/cancel`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => {
        // Check if response is JSON
        const contentType = r.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return r.text().then(text => {
                throw new Error(`Server returned non-JSON response. Status: ${r.status}. Response: ${text.substring(0, 200)}`);
            });
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            // Refresh task status after a short delay
            setTimeout(() => {
                refreshTaskStatus();
            }, 1000);
        } else {
            alert(`Failed to cancel task: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(e => {
        alert(`Error cancelling task: ${e.message}`);
    });
}

// Task log cache
const taskLogCache = {};

// Task Status function
function refreshTaskStatus() {
    const scrollY = window.scrollY;
    fetchWithCSRF('/api/tasks?lightweight=true')
    .then(r => r.json())
    .then(data => {
        if (data.success && data.tasks) {
            refreshTaskStatusFromData(data.tasks);
        } else {
            // Clear all containers
            ['all', 'running', 'completed', 'failed', 'cancelled'].forEach(status => {
                const container = document.getElementById(`task-status-container-${status}`);
                if (container) {
                    container.innerHTML = '<p class="text-muted">No tasks found.</p>';
                }
            });
            window.scrollTo(0, scrollY);
        }
    })
    .catch(e => {
        ['all', 'running', 'completed', 'failed', 'cancelled'].forEach(status => {
            const container = document.getElementById(`task-status-container-${status}`);
            if (container) {
                container.innerHTML = `<p class="text-danger">Error loading tasks: ${e.message}</p>`;
            }
        });
        window.scrollTo(0, scrollY);
    });
}

function renderTasksTable(container, tasks, loadLogs = false) {
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-muted">No tasks in this category.</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover table-sm table-resizable">';
    html += '<thead><tr><th>Task ID</th><th>Script</th><th>Status</th><th>Current Action</th><th>Last Log Line</th><th>Progress</th><th>Started</th><th>Actions</th></tr></thead><tbody>';
    
    tasks.forEach(([taskId, task]) => {
        const statusBadge = task.status === 'completed' ? 'bg-success' :
                           task.status === 'failed' ? 'bg-danger' :
                           task.status === 'cancelled' ? 'bg-warning' :
                           task.status === 'running' ? 'bg-primary' : 'bg-secondary';
        const progress = task.progress || 0;
        const currentAction = task.current_action || task.message || 'N/A';
        const started = task.started_at ? new Date(task.started_at).toLocaleString() : 'N/A';
        
        // Get cached log line or show placeholder
        const cachedLog = taskLogCache[taskId];
        let logLine = 'N/A';
        let logTitle = '';
        
        if (cachedLog && cachedLog.log_line) {
            // Show more text - up to 500 characters, with full text in title
            logLine = escapeHtml(cachedLog.log_line).substring(0, 500);
            if (cachedLog.log_line.length > 500) {
                logLine += '...';
            }
            logTitle = escapeHtml(cachedLog.log_line);
        } else if (task.status === 'running') {
            logLine = '<em class="text-muted">Loading log...</em>';
            logTitle = 'Log is being loaded...';
        } else {
            logLine = '<em class="text-muted">No log available</em>';
            logTitle = 'No log file found or log file is empty';
        }
        
        html += `<tr>
            <td><code>${taskId.substring(0, 20)}...</code></td>
            <td>${task.script || 'N/A'}</td>
            <td><span class="badge ${statusBadge}">${task.status || 'unknown'}</span></td>
            <td><small class="text-muted">${escapeHtml(currentAction)}</small></td>
            <td><small class="text-muted" id="log-${taskId}" style="font-family: monospace; font-size: 0.85em; white-space: normal; word-wrap: break-word; max-width: 1000px; display: block;" title="${logTitle}">${logLine}</small></td>
            <td>
                <div class="progress" style="height: 20px; width: 100px;">
                    <div class="progress-bar ${task.status === 'running' ? 'progress-bar-striped progress-bar-animated' : ''}" 
                         role="progressbar" style="width: ${progress}%">${progress}%</div>
                </div>
            </td>
            <td><small>${started}</small></td>
            <td>
                ${task.status === 'running' ? `<button class="btn btn-sm btn-outline-warning" onclick="cancelTask('${taskId}')" title="Cancel this task">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>` : ''}
                ${task.status === 'failed' ? `<button class="btn btn-sm btn-outline-danger" onclick="showTaskError('${taskId}')">View Error</button>` : ''}
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    // Make the table resizable
    const table = container.querySelector('table');
    if (table && typeof makeTableResizable === 'function') {
        makeTableResizable(table);
    }
}

function loadTaskLogs(taskIds) {
    if (!taskIds || taskIds.length === 0) {
        return;
    }
    
    // Load logs in parallel (batch requests)
    const logPromises = taskIds.map(taskId => 
        fetch(`/api/tasks/${taskId}/last-log`)
            .then(r => {
                // Check if response is JSON
                const contentType = r.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return r.text().then(text => {
                        console.error(`[loadTaskLogs] Non-JSON response for ${taskId}:`, text.substring(0, 200));
                        throw new Error(`Server returned non-JSON response. Status: ${r.status}`);
                    });
                }
                return r.json();
            })
            .then(data => {
                console.log(`[loadTaskLogs] Loaded log for ${taskId}:`, {
                    success: data.success,
                    hasLogLine: !!data.log_line,
                    logLineLength: data.log_line ? data.log_line.length : 0
                });
                return { taskId, data };
            })
            .catch(e => {
                console.error(`[loadTaskLogs] Error loading log for ${taskId}:`, e);
                console.error(`[loadTaskLogs] Task ID: ${taskId}, Error type: ${e.constructor.name}, Message: ${e.message}`);
                return { taskId, data: { success: false, error: e.message } };
            })
    );
    
    Promise.all(logPromises).then(results => {
        results.forEach(({ taskId, data }) => {
            if (data.success) {
                // Update cache
                taskLogCache[taskId] = {
                    log_line: data.log_line,
                    timestamp: data.timestamp
                };
                
                // Update UI
                const logElement = document.getElementById(`log-${taskId}`);
                if (logElement) {
                    if (data.log_line) {
                        // Show up to 500 characters with full text in title
                        const fullLogText = escapeHtml(data.log_line);
                        let displayText = fullLogText.substring(0, 500);
                        if (fullLogText.length > 500) {
                            displayText += '...';
                        }
                        logElement.textContent = displayText;
                        logElement.title = fullLogText; // Full text on hover
                        logElement.style.maxWidth = '1000px';
                        logElement.style.whiteSpace = 'normal';
                        logElement.style.wordWrap = 'break-word';
                    } else {
                        logElement.innerHTML = '<em class="text-muted">No log yet</em>';
                        logElement.title = 'Log file exists but is empty or no log entries found';
                        console.warn(`[loadTaskLogs] Task ${taskId}: Log file exists but log_line is empty`);
                    }
                } else {
                    console.warn(`[loadTaskLogs] Task ${taskId}: Log element not found in DOM`);
                }
            } else {
                // Log failure details
                const logElement = document.getElementById(`log-${taskId}`);
                if (logElement) {
                    const errorMsg = data.error || 'Failed to load log';
                    logElement.innerHTML = `<em class="text-danger">Error: ${escapeHtml(errorMsg)}</em>`;
                    logElement.title = `Failed to load log: ${escapeHtml(errorMsg)}`;
                    console.error(`[loadTaskLogs] Task ${taskId}: Failed to load log - ${errorMsg}`);
                } else {
                    console.error(`[loadTaskLogs] Task ${taskId}: Failed to load log and element not found`);
                }
            }
        });
    });
}

function clearCompletedTasks() {
    if (!confirm('Are you sure you want to clear all completed, failed, and cancelled tasks?')) {
        return;
    }
    
    fetchWithCSRF('/api/tasks/clear-completed', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Clear log cache for removed tasks
            Object.keys(taskLogCache).forEach(taskId => {
                delete taskLogCache[taskId];
            });
            
            // Refresh task status
            setTimeout(() => {
                refreshTaskStatus();
            }, 500);
        } else {
            alert(`Failed to clear tasks: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(e => {
        alert(`Error clearing tasks: ${e.message}`);
    });
}

// Auto-refresh task status every 5 seconds if page is visible
let refreshInterval;
let logRefreshInterval;
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data in parallel
    Promise.all([
        fetch('/api/credentials').then(r => r.json()),
        fetch('/api/tasks?lightweight=true').then(r => r.json()),
        fetch('/api/logs').then(r => r.json())
    ]).then(([credentialsData, tasksData, logsData]) => {
        // Handle credentials
        if (credentialsData.success) {
            const container = document.getElementById('accounts-container');
            const badge = document.getElementById('credentials-count-badge');
            if (container && badge) {
                badge.textContent = `${credentialsData.count} account(s)`;
                if (credentialsData.rotation_enabled) {
                    badge.className = 'badge bg-success';
                    badge.title = 'Rotation enabled - accounts will be rotated automatically';
                } else {
                    badge.className = 'badge bg-secondary';
                    badge.title = 'Single account - add more for rotation';
                }
                
                if (credentialsData.accounts && credentialsData.accounts.length > 0) {
                    container.innerHTML = credentialsData.accounts.map((acc, index) => `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${acc.username || '(No username)'}</strong>
                                        <br><small class="text-muted">Token: ${acc.api_token || 'Not set'}</small>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="removeAccount(${index})">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="alert alert-warning">No accounts configured. Add an account below.</div>';
                }
            }
        }
        
        // Handle tasks
        if (tasksData.success && tasksData.tasks) {
            refreshTaskStatusFromData(tasksData.tasks);
        }
        
        // Handle logs
        if (logsData.success) {
            const select = document.getElementById('log-file-select');
            if (select) {
                select.innerHTML = '<option value="">-- Select a log file --</option>';
                logsData.logs.forEach(log => {
                    const sizeKB = (log.size / 1024).toFixed(2);
                    const option = document.createElement('option');
                    option.value = log.name;
                    option.textContent = `${log.name} (${sizeKB} KB)`;
                    select.appendChild(option);
                });
            }
        }
    }).catch(e => {
        console.error('Error loading initial data:', e);
        // Fallback to sequential loading
        refreshTaskStatus();
        loadLogFiles();
    });
    
    // Refresh task status every 10 seconds (increased from 5)
    refreshInterval = setInterval(() => {
        fetch('/api/tasks?lightweight=true')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.tasks) {
                    refreshTaskStatusFromData(data.tasks);
                }
            })
            .catch(e => console.error('Error refreshing tasks:', e));
    }, 10000);
    
    // Refresh logs for running tasks every 10 seconds (increased from 5)
    logRefreshInterval = setInterval(() => {
        fetchWithCSRF('/api/tasks?lightweight=true')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.tasks) {
                const runningTasks = Object.entries(data.tasks)
                    .filter(([_, task]) => task.status === 'running')
                    .map(([id]) => id);
                
                if (runningTasks.length > 0) {
                    loadTaskLogs(runningTasks);
                    // Update last update time
                    const now = new Date();
                    const updateEl = document.getElementById('last-update-time');
                    if (updateEl) {
                        updateEl.textContent = `Last update: ${now.toLocaleTimeString()}`;
                    }
                }
            }
        })
        .catch(e => console.error('Error refreshing logs:', e));
    }, 10000);
    
    setInterval(loadLogFiles, 60000); // Refresh log list every minute
});

function refreshTaskStatusFromData(tasks) {
    const scrollY = window.scrollY;
    
    const tasksList = Object.entries(tasks).sort((a, b) => {
        const timeA = new Date(a[1].started_at || 0).getTime();
        const timeB = new Date(b[1].started_at || 0).getTime();
        return timeB - timeA; // Newest first
    });
    
    // Group tasks by status
    const tasksByStatus = {
        'all': tasksList,
        'running': tasksList.filter(([_, task]) => task.status === 'running'),
        'completed': tasksList.filter(([_, task]) => task.status === 'completed'),
        'failed': tasksList.filter(([_, task]) => task.status === 'failed'),
        'cancelled': tasksList.filter(([_, task]) => task.status === 'cancelled')
    };
    
    // Check if tracked tasks have completed and re-enable buttons
    const buttonMap = {
        'download': 'btn-download',
        'download-descriptions': 'btn-download-descriptions',
        'scrape-apps': 'btn-scrape-apps',
        'scrape-versions': 'btn-scrape-versions',
        'pipeline': 'btn-pipeline',
        'build-index': 'btn-build-index'
    };
    
    Object.keys(activeTaskIds).forEach(taskType => {
        const taskId = activeTaskIds[taskType];
        if (taskId && tasks[taskId]) {
            const task = tasks[taskId];
            // If task is completed, failed, or cancelled, re-enable the button
            if (task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled') {
                const btnId = buttonMap[taskType];
                if (btnId) {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = false;
                    }
                }
                // Clear the tracked task ID
                activeTaskIds[taskType] = null;
            }
        } else if (taskId && !tasks[taskId]) {
            // Task not found (might have been cleared), re-enable button
            const btnId = buttonMap[taskType];
            if (btnId) {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = false;
                }
            }
            activeTaskIds[taskType] = null;
        }
    });
    
    // Render each tab
    Object.keys(tasksByStatus).forEach(status => {
        const container = document.getElementById(`task-status-container-${status}`);
        if (container) {
            renderTasksTable(container, tasksByStatus[status], status === 'running');
        }
    });
    
    // Update last update time
    const now = new Date();
    const updateEl = document.getElementById('last-update-time');
    if (updateEl) {
        updateEl.textContent = `Last update: ${now.toLocaleTimeString()}`;
    }
    
    // Load logs for running tasks
    if (tasksByStatus.running.length > 0) {
        loadTaskLogs(tasksByStatus.running.map(([id]) => id));
    }
    
    // Restore scroll position
    requestAnimationFrame(() => {
        window.scrollTo(0, scrollY);
    });
}

// Stop refreshing when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        if (refreshInterval) clearInterval(refreshInterval);
    } else {
        refreshTaskStatus();
        refreshInterval = setInterval(refreshTaskStatus, 5000);
    }
});
</script>
{% endblock %}

